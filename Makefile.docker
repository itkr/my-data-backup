# Dockerç”¨ã®Makefileæ‹¡å¼µ
# æ—¢å­˜ã®Makefileã«ä»¥ä¸‹ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨

.PHONY: help docker-build docker-run docker-gui docker-clean docker-logs
.DEFAULT_GOAL := help

# Docker ã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
help: ## ğŸ“‹ Dockerç”¨ã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo "ğŸ³ Docker ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§"
	@echo "========================"
	@echo ""
	@echo "ğŸš€ åŸºæœ¬æ“ä½œ:"
	@echo "  make -f Makefile.docker docker-build              ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make -f Makefile.docker docker-run                ğŸš€ CLIãƒ¢ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•"
	@echo "  make -f Makefile.docker docker-gui                ğŸ¨ GUIãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã¨èµ·å‹•"
	@echo "  make -f Makefile.docker docker-shell              ğŸš ã‚³ãƒ³ãƒ†ãƒŠã‚·ã‚§ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹"
	@echo ""
	@echo "ğŸ“± ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ:"
	@echo "  make -f Makefile.docker docker-photo-organizer    ğŸ“¸ Photo Organizer CLI"
	@echo "  make -f Makefile.docker docker-move               ğŸ“ Move CLI"
	@echo "  make -f Makefile.docker docker-photo-organizer-gui ğŸ¨ Photo Organizer GUI"
	@echo "  make -f Makefile.docker docker-move-gui           ğŸ¨ Move GUI"
	@echo ""
	@echo "ğŸ”§ ç®¡ç†ãƒ»ç›£è¦–:"
	@echo "  make -f Makefile.docker docker-status             ğŸ“Š Dockerç’°å¢ƒã®çŠ¶æ…‹ç¢ºèª"
	@echo "  make -f Makefile.docker docker-logs               ğŸ“‹ ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ã‚’è¡¨ç¤º"
	@echo "  make -f Makefile.docker docker-clean              ğŸ§¹ ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤"
	@echo "  make -f Makefile.docker docker-clean-all          ğŸ—‘ï¸  ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚å«ã‚ã¦å®Œå…¨å‰Šé™¤"
	@echo ""
	@echo "ğŸ’¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆä¾‹:"
	@echo "  # 1. ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make -f Makefile.docker docker-build"
	@echo ""
	@echo "  # 2a. CLIä½¿ç”¨ã®å ´åˆ"
	@echo "  make -f Makefile.docker docker-run"
	@echo "  make -f Makefile.docker docker-photo-organizer"
	@echo ""
	@echo "  # 2b. GUIä½¿ç”¨ã®å ´åˆï¼ˆmacOS/Linuxï¼‰"
	@echo "  make -f Makefile.docker docker-gui"
	@echo ""
	@echo "ğŸ“– è©³ç´°: DOCKER.md ã‚’å‚ç…§"
	@echo ""

# è©³ç´°ãªãƒ˜ãƒ«ãƒ—ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
help-detailed: ## ğŸ“– è©³ç´°ãªãƒ˜ãƒ«ãƒ—ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±
	@echo "ğŸ³ Docker è©³ç´°ãƒ˜ãƒ«ãƒ— & ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ”§ äº‹å‰æº–å‚™:"
	@echo "  1. Docker & Docker Compose ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª"
	@echo "     docker --version && docker-compose --version"
	@echo ""
	@echo "  2. GUIä½¿ç”¨æ™‚ã®æº–å‚™"
	@echo "     macOS: brew install --cask xquartz"
	@echo "     Linux: sudo apt-get install x11-apps"
	@echo ""
	@echo "ğŸ“ ãƒ‡ãƒ¼ã‚¿é…ç½®:"
	@echo "  ./data/           â† å‡¦ç†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®"
	@echo "  ./logs/           â† ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã‚‹"
	@echo "  ./export/         â† å‡¦ç†çµæœãŒå‡ºåŠ›ã•ã‚Œã‚‹"
	@echo ""
	@echo "ğŸš¨ ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ³•:"
	@echo "  âŒ GUI ãŒè¡¨ç¤ºã•ã‚Œãªã„"
	@echo "     â†’ XQuartz/X11ã®è¨­å®šç¢ºèª: xhost +localhost"
	@echo "     â†’ DISPLAYç’°å¢ƒå¤‰æ•°ç¢ºèª: echo \$$DISPLAY"
	@echo ""
	@echo "  âŒ Permission denied"
	@echo "     â†’ ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ç¢ºèª: chmod -R 755 data/"
	@echo ""
	@echo "  âŒ Container won't start"
	@echo "     â†’ ãƒ­ã‚°ç¢ºèª: docker-compose logs"
	@echo "     â†’ ã‚¤ãƒ¡ãƒ¼ã‚¸å†ãƒ“ãƒ«ãƒ‰: docker-compose build --no-cache"
	@echo ""
	@echo "ğŸ”„ å®Œå…¨ãƒªã‚»ãƒƒãƒˆæ‰‹é †:"
	@echo "  1. make -f Makefile.docker docker-clean-all"
	@echo "  2. docker system prune -a"
	@echo "  3. make -f Makefile.docker docker-build"
	@echo ""
	@echo "ğŸ“š å‚è€ƒè³‡æ–™:"
	@echo "  - è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: DOCKER.md"
	@echo "  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±: README.md"
	@echo "  - ãƒˆãƒ©ãƒ–ãƒ«å ±å‘Š: https://github.com/itkr/my-data-backup/issues"
	@echo ""

.PHONY: help help-detailed docker-build docker-run docker-gui docker-clean docker-logs docker-photo-organizer docker-move docker-photo-organizer-gui docker-move-gui docker-shell docker-clean-all docker-status

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
docker-build: ## ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ³ Building Docker image..."
	docker build -t my-data-backup:latest .

# CLIãƒ¢ãƒ¼ãƒ‰ã§Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker-run: ## ğŸš€ CLIãƒ¢ãƒ¼ãƒ‰ã§Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
	@echo "ğŸš€ Starting Docker container (CLI mode)..."
	docker-compose up -d my-data-backup-cli
	@echo "âœ… Container started. Use 'docker exec -it my-data-backup-cli bash' to access."

# GUIå¯¾å¿œã§Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
docker-gui: ## ğŸ¨ GUIãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šã¨èµ·å‹•ï¼ˆX11ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
	@echo "ğŸ¨ Setting up GUI environment..."
	./scripts/docker-gui.sh

# Photo Organizer CLIã‚’Dockerã§å®Ÿè¡Œ
docker-photo-organizer: ## ğŸ“¸ Photo Organizer CLIã‚’Dockerã§å®Ÿè¡Œ
	@echo "ğŸ“¸ Running Photo Organizer (CLI) in Docker..."
	@if [ -z "$(SRC)" ] || [ -z "$(DIR)" ]; then \
		echo "ä½¿ç”¨æ–¹æ³•: make docker-run-photo-organizer SRC=<ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª> DIR=<å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>"; \
		echo "ä¾‹: make docker-run-photo-organizer SRC=/tmp/test_source DIR=/tmp/test_output"; \
		exit 1; \
	fi
	docker exec -it my-data-backup-cli bash -c "cd /app/photo_organizer && python main.py --src $(SRC) --dir $(DIR)"

# Move CLIã‚’Dockerã§å®Ÿè¡Œ
docker-move: ## ğŸ“ Move CLIã‚’Dockerã§å®Ÿè¡Œ
	@echo "ğŸ“ Running Move tool (CLI) in Docker..."
	@if [ -z "$(SRC)" ] || [ -z "$(DEST)" ]; then \
		echo "ä½¿ç”¨æ–¹æ³•: make docker-run-move SRC=<ã‚½ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª> DEST=<ç§»å‹•å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª>"; \
		echo "ä¾‹: make docker-run-move SRC=/tmp/test_source DEST=/tmp/test_dest"; \
		exit 1; \
	fi
	docker exec -it my-data-backup-cli bash -c "cd /app/move && python main.py --import-dir $(SRC) --export-dir $(DEST)"

# Photo Organizer GUIã‚’Dockerã§å®Ÿè¡Œ
docker-photo-organizer-gui: ## ğŸ¨ Photo Organizer GUIã‚’Dockerã§å®Ÿè¡Œ
	@echo "ğŸ¨ Running Photo Organizer (GUI) in Docker..."
	docker exec -it my-data-backup-gui python photo_organizer/gui.py

# Move GUIã‚’Dockerã§å®Ÿè¡Œ
docker-move-gui: ## ğŸ¨ Move GUIã‚’Dockerã§å®Ÿè¡Œ
	@echo "ğŸ¨ Running Move tool (GUI) in Docker..."
	docker exec -it my-data-backup-gui python move/gui.py

# Dockerã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹
docker-shell: ## ğŸš Dockerã‚³ãƒ³ãƒ†ãƒŠã®ã‚·ã‚§ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
	@echo "ğŸš Accessing Docker container shell..."
	docker exec -it my-data-backup-cli bash

# Dockerã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º
docker-logs: ## ğŸ“‹ Dockerã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ Showing Docker container logs..."
	docker-compose logs -f

# Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
docker-clean: ## ğŸ§¹ Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
	@echo "ğŸ§¹ Cleaning up Docker containers..."
	docker-compose down
	docker system prune -f

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚å«ã‚ã¦å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
docker-clean-all: docker-clean ## ğŸ—‘ï¸ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚å«ã‚ã¦å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ—‘ï¸ Removing Docker images..."
	docker rmi my-data-backup:latest || true
	docker image prune -f

# Dockerç’°å¢ƒã®çŠ¶æ…‹ç¢ºèª
docker-status: ## ğŸ“Š Dockerç’°å¢ƒã®çŠ¶æ…‹ç¢ºèª
	@echo "ğŸ“Š Docker Environment Status"
	@echo "============================"
	@echo "ğŸ³ Docker Version:"
	@docker --version || echo "âŒ Docker not installed"
	@echo ""
	@echo "ğŸ“¦ Containers:"
	@docker ps -a --filter "name=my-data-backup" || echo "âŒ No containers found"
	@echo ""
	@echo "ğŸ—ï¸ Images:"
	@docker images | grep my-data-backup || echo "âŒ No images found"
